---
description: 生码 + 自动验证一体化命令
---

# /androidDev.dev

## 用户输入

$ARGUMENTS

---

## 概述

你将根据用户的功能描述：
1. 编写代码实现功能
2. 自动编译部署
3. 运行验证代码正确性
4. 验证完成后清理调试日志

---

## 前置检查

检查 `.adevtools/config.json` 是否存在：

- **如果不存在**：自动执行初始化流程（按 /androidDev.init 的阶段1-2 执行），生成配置文件后继续
- **如果存在**：加载配置信息

读取 `.adevtools/routes.md`：
- 加载页面路由配置, 用于匹配页面入口

---

## 阶段1：代码实现

### 步骤1：理解需求

解析用户输入：
- 要实现什么功能
- 涉及哪些文件或类
- 关联哪个页面入口（从路由配置匹配）

输出需求理解，让用户确认理解是否正确。

### 步骤2：规划日志插桩点

在编写代码前，先规划需要插入日志的关键位置（中文描述）：
- **初始化点**：组件/功能的初始化位置，记录是否成功初始化
- **用户交互点**：按钮点击、输入等用户操作的入口
- **业务逻辑点**：关键业务逻辑的执行位置
- **分支判断点**：if/switch等条件分支的判断结果
- **数据处理点**：数据获取、转换、保存等关键数据操作
- **异步回调点**：异步操作的开始和结束
- **异常处理点**：try-catch、错误处理的位置

示例输出：
```
日志插桩规划：
1. 初始化点：initFloatingActionButton() 方法开始，记录按钮是否找到
2. 用户交互点：按钮点击监听器，记录用户点击事件
3. 业务逻辑点：showInputDialog() 方法开始，记录对话框构建
4. 数据处理点：输入框创建完成，确认UI组件就绪
5. 用户交互点：确定按钮点击，记录用户输入的内容
6. 数据处理点：Toast显示，记录Toast的内容
7. 用户交互点：取消按钮点击，记录对话框关闭
```

### 步骤3：分析现有代码与依赖

读取相关源文件：
- 理解当前架构和代码风格
- 分析调用链路
- **检查 `build.gradle` 的 dependencies**：确认可用依赖

**增量编译限制**：
- 禁止添加新的Maven仓库或依赖库
- 只能使用项目已有依赖和Android原生组件

### 步骤4：设计实现方案

根据步骤3的分析：
- 列出需要的组件，确认都可用（已有依赖或原生）
- 不可用时设计替代方案（参考"注意事项-依赖检查"）


### 步骤5：编写代码

实现功能：
- 遵循现有代码风格
- 只使用已有依赖和原生组件
- 按步骤2规划添加调试日志
- 优先使用代码动态创建UI，避免修改复杂xml布局

**日志规范**（使用配置中的 logPrefix）：
- 函数入口：`Logger.d(TAG, "ADEV_DEBUG: methodName - 描述 + 关键参数")`
- 决策分支：`Logger.d(TAG, "ADEV_DEBUG: 条件判断 - 结果: xxx")`
- 异步操作：`Logger.d(TAG, "ADEV_DEBUG: 操作名称 - started/completed")`
- 异常情况：`Logger.e(TAG, "ADEV_DEBUG: 错误描述 - " + errorMessage)`

### 步骤6：生成验证TODO

基于步骤2的日志规划，生成TODO文件到 `.adevtools/dev-todos/`
- 文件名：`{timestamp}_{功能简述}.md`
- 内容：功能描述、TODO列表、验证步骤、预期日志、检查点

示例：
```markdown
# 验证TODO: 搜索结果页浮层对话框

## 功能描述
在搜索结果页添加浮层按钮，点击弹出输入对话框

## TODO 列表
- [ ] 页面初始化验证
- [ ] 点击按钮验证

## 验证步骤

### 1. 页面初始化验证
**操作：** 打开搜索结果页

**预期日志：**
- `ADEV_DEBUG: initPage - 页面初始化成功`
- `ADEV_DEBUG: initFloatingButton - 开始初始化`

**检查点：** 按钮是否显示

### 2. 点击按钮验证
**操作：** 点击浮层按钮

**预期日志：**
- `ADEV_DEBUG: clickFloatingButton - 用户点击`
- `ADEV_DEBUG: initDialog - 开始初始化Dialog`

**检查点：** 对话框是否弹出
```

### 步骤7：总结变更

输出修改的文件、主要变更、日志关键词、TODO文件路径

---

## 阶段2：编译检查

在进行打包部署前，先进行快速编译检查以尽早发现错误。

### 执行编译检查

运行编译检查脚本：
```bash
sh /path/to/.adevtools/android-compile.sh
```

**脚本功能**：
- 只编译 Java 和 Kotlin 代码，不生成 APK
- 使用 Gradle Daemon 和增量编译加速
- 快速发现编译错误（通常 7-30 秒）

### 处理结果

**如果编译通过**：
- 继续进行阶段3的完整编译部署

**如果编译失败**：
- 修复代码后重新执行编译检查
- 直到编译通过后再进行完整编译部署

---

## 阶段3：编译部署

### 使用异步构建脚本

长时间构建任务使用异步构建脚本避免超时:

**启动构建**:
```bash
.cursor/commands/scripts/async_run_build.sh start
```

**查询构建状态**:
```bash
.cursor/commands/scripts/async_run_build.sh status
```
- 返回执行状态(running/completed)和最后50行日志
- 根据输出的 `Suggestion` 调整查询间隔(前2分钟20-40秒,之后5-10秒)
- 持续查询直到状态变为 `completed`


---

## 阶段4：运行验证

### 步骤1：准备验证

- 读取 `.adevtools/dev-todos/` 中生成的TODO文件
- 解析验证步骤和预期日志

### 步骤2：进入目标页面

- 使用 `open_url`（从routes.md获取URL，指定packageName，waitSeconds≥5）
- 截图确认页面状态
- 立即捕获初始化日志

### 步骤3：逐步验证

按TODO文件逐步执行，每次操作后：
1. 等待1-2秒
2. 截图确认UI变化
3. 捕获日志
4. 对比实际日志与预期

### 步骤4：日志验证分析

捕获日志（使用 logPrefix 过滤，限制50行），检查：
- 完整性：预期日志是否都出现
- 顺序性：顺序是否符合逻辑
- 内容性：参数数据是否正确
- 异常性：是否有ERROR/WARN
- 遗漏性：是否缺少关键日志

输出验证结果矩阵

### 步骤5：处理问题

如果没有问题则跳过这一步，如果出现了问题则要：
- 代码逻辑问题：修复代码，重新编译部署，重新验证
- 日志遗漏问题：补充日志，重新编译部署，重新验证
- MCP操作限制：调整验证方式
- 环境问题：说明原因

### 步骤6：更新TODO文件

每完成一步验证就及时更新TODO列表状态 `[x]`，一定是每完成一步就更新

### 步骤7：生成验证报告

保存到 `.adevtools/dev-reports/`，包含：
- 时间戳、功能描述、修改文件
- 验证步骤和结果（引用TODO）
- 日志片段、截图列表
- 发现问题和解决方案
- 验证结论

---

## 阶段5：清理调试日志

删除本次添加的调试日志，列出清理位置

## 阶段6：输出总结

展示修改文件、验证结果、关键发现、验证报告路径

---

## MCP 工具使用

### 配置集成

- 读取 `.adevtools/config.json`（包名、编译命令、日志前缀）
- 读取 `.adevtools/routes.md`（页面路由、URL）

### 失败处理

- **编译失败**：检查是否添加新依赖，修复，重新编译
- **验证失败**：分析原因，修复代码或调整操作，重新验证
- **操作失败**：press_key(key="back")，重新分析页面，尝试其他定位方式

---

## 注意事项

### 通用规则
1. 编译失败持续修复直到成功
2. 验证失败分析原因并修复
3. 所有配置从配置文件读取

### 依赖检查（重要）

**增量编译限制**：
- 严禁添加Maven仓库或依赖库
- 只能使用已有依赖和Android原生组件

**检查方法**：编码前读取 `/build.gradle` 确认依赖可用性

### MCP操作技巧
- 页面加载等待不少于5秒
- 元素定位顺序：text、resourceId、hierarchyId（禁用坐标）
- 先处理权限/通知弹窗干扰

### 编译错误处理
- 依赖缺失：用原生组件替代
- 版本降级：先卸载
- 排查顺序：新依赖检查、语法错误、导入错误、编译命令

### 日志最佳实践
- 分段捕获（每步操作后立即捕获）
- 命名规范：`ADEV_DEBUG: 功能_操作 - 详细信息`
- 记录关键参数数据
- 避免日志泛滥

### 编译注意
- 在进行编译的时候可能需要等待异步脚本的执行，等待的时间不允许超过30秒，否则Agent的执行很容易超时导致任务中断
- 等待的方式通过 sleep 进行，例如：sleep 25 && async_run_build.sh status


