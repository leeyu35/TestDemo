---
description: Android 验证专用命令 - 分析代码 + 规划日志 + 验证功能
---

# /androidDev.dev.verify

## 用户输入

$ARGUMENTS

---

## 概述

对已有代码进行验证：
1. 分析现有代码和规划验证日志
2. 编译部署（如有代码变更）
3. 运行验证并产出报告
4. 清理调试日志

---

## 前置检查

- 检查 `.adevtools/config.json`（不存在则初始化）
- 读取 `.adevtools/routes.md`（页面路由）, 用于匹配页面入口

---

## 阶段1：分析代码与规划日志

### 步骤1：理解验证目标

**自动识别验证范围**（优先级从高到低）：
1. 用户明确指定：直接使用
2. 查看聊天历史：从历史中识别最近开发的功能
3. 检查 git status：获取未提交的文件，分析修改内容确定验证范围

输出验证目标确认

### 步骤2：分析代码与规划日志

读取相关源文件，分析：核心方法、调用链路、日志覆盖

规划日志插桩（7类）：初始化、交互、逻辑、分支、数据、异步、异常
**日志规范**（使用配置中的 logPrefix）：
- 函数入口：`Logger.d(TAG, "ADEV_DEBUG: methodName - 描述 + 关键参数")`
- 决策分支：`Logger.d(TAG, "ADEV_DEBUG: 条件判断 - 结果: xxx")`
- 异步操作：`Logger.d(TAG, "ADEV_DEBUG: 操作名称 - started/completed")`
- 异常情况：`Logger.e(TAG, "ADEV_DEBUG: 错误描述 - " + errorMessage)`


输出：【需新增】和【已存在】的日志

### 步骤3：插入日志并生成TODO

插入验证日志（遵循logPrefix规范）

生成TODO到 `.adevtools/dev-todos/{timestamp}_verify_{功能}.md`
- 内容：功能描述、验证步骤、预期日志、检查点

示例：
```markdown
# 验证TODO: 搜索结果页浮层对话框

## 功能描述
在搜索结果页添加浮层按钮，点击弹出输入对话框

## TODO 列表
- [ ] 页面初始化验证
- [ ] 点击按钮验证

## 验证步骤

### 1. 页面初始化验证
**操作：** 打开搜索结果页

**预期日志：**
- `ADEV_DEBUG: initPage - 页面初始化成功`
- `ADEV_DEBUG: initFloatingButton - 开始初始化`

**检查点：** 按钮是否显示

### 2. 点击按钮验证
**操作：** 点击浮层按钮

**预期日志：**
- `ADEV_DEBUG: clickFloatingButton - 用户点击`
- `ADEV_DEBUG: initDialog - 开始初始化Dialog`

**检查点：** 对话框是否弹出
```


---
## 阶段2：编译检查

在修改代码的情况下，需要先进行快速编译检查以尽早发现错误。如果没有改过代码，则跳过该阶段。

### 执行编译检查

运行编译检查脚本：
```bash
sh /path/to/.adevtools/android-compile.sh
```

**脚本功能**：
- 只编译 Java 和 Kotlin 代码，不生成 APK
- 使用 Gradle Daemon 和增量编译加速
- 快速发现编译错误（通常 7-30 秒）

### 处理结果

**如果编译通过**：
- 继续进行阶段3的完整编译部署

**如果编译失败**：
- 修复代码后重新执行编译检查
- 直到编译通过后再进行完整编译部署

---

## 阶段3：编译部署

在修改代码的情况下需要进行完整编译部署，如果没有改过代码，则跳过该阶段

### 使用异步构建脚本

长时间构建任务使用异步构建脚本避免超时:

**启动构建**:
```bash
.cursor/commands/scripts/async_run_build.sh start
```

**查询构建状态**:
```bash
.cursor/commands/scripts/async_run_build.sh status
```
- 返回执行状态(running/completed)和最后50行日志
- 根据输出的 `Suggestion` 调整查询间隔(前2分钟20-40秒,之后5-10秒)
- 持续查询直到状态变为 `completed`

## 阶段4：运行验证

### 步骤1：准备

1. 确认设备连接
2. 读取TODO文件
3. 打开页面（waitSeconds不少于5秒）
4. 截图确认页面状态
5. 捕获初始化日志

### 步骤2：逐场景验证（关键：每验证完一个场景立即捕获日志）

**每个场景必须立即执行完整流程**：
1. 执行操作
2. 等待1-2秒
3. 截图
4. **立即捕获日志**（logPrefix过滤，50行）注意：不要等所有场景做完再捕获，日志会被冲掉
5. 对比日志与预期
6. 记录结果（成功/部分成功/失败）

**5维度日志检查**：完整性、顺序性、内容性、异常性、遗漏性

输出验证结果矩阵

### 步骤3：处理问题

- 代码问题：修复代码，重新编译，重新验证该场景
- 日志遗漏：补充日志，重新编译，重新验证该场景
- MCP限制：记录限制原因，调整验证方式
- 环境问题：记录问题和解决方案

记录问题修复过程

### 步骤4：生成报告

保存到 `.adevtools/dev-reports/{timestamp}_verify_{功能}.md`

包含：验证概述、代码分析、场景详情、日志分析（5维度表格）、问题与修复、限制说明、截图、验证结论

更新TODO标记完成状态

---

## 阶段5：清理日志

列出日志位置，删除所有调试日志，重新编译确认

## 阶段6：输出总结

输出：验证功能、场景统计、维度结果、问题修复、限制说明、报告路径、验证结论

---

## MCP 工具使用

- 读取 `.adevtools/config.json` 和 `.adevtools/routes.md`
- 操作：`open_url` / `tap(text-resourceId-hierarchyId优先级)` / `screenshot` / `get_logs`
- 失败处理：编译失败时修复，场景失败时修复该场景，操作失败时back重试

---

## 注意事项

### 核心原则
- 只插桩日志，不改业务逻辑
- **每个场景验证完立即捕获日志**（日志会被冲掉）
- 验证失败必须修复或记录
- 验证完成必须清理日志

### 验证目标识别
1. 用户指定：直接使用
2. 查聊天历史：识别最近开发功能
3. git status：分析未提交文件

### 日志策略
- 避免重复，只在关键路径插桩
- 命名规范：`ADEV_DEBUG: 功能_操作 - 详情`

### 场景设计
- 覆盖核心功能，包含正常和异常场景
- 每个场景独立，有明确预期

### MCP技巧
- 页面等待不少于5秒
- 定位顺序：text、resourceId、hierarchyId
- **每步操作后立即捕获日志**
- 先处理弹窗

### 报告要求
- 场景详情完整，问题分析清晰
- 修复方案明确，结论有数据支撑

### 编译注意
在进行编译的时候可能需要等待异步脚本的执行，等待的时间不允许超过30秒，否则Agent的执行很容易超时导致任务中断





